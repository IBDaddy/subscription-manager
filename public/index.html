<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#334155">
  <meta name="description" content="„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÇíÊ∫ÄË∂≥Â∫¶„Å®‰ΩøÁî®È†ªÂ∫¶„ÅßÁÆ°ÁêÜ„Åó„ÄÅËß£Á¥Ñ„Çø„Ç§„Éü„É≥„Ç∞„ÇíÊúÄÈÅ©Âåñ">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="„Çµ„Éñ„Çπ„ÇØÁÆ°ÁêÜ">
  <title>„Çµ„Éñ„Çπ„ÇØÁÆ°ÁêÜ</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Recharts dependencies via jsDelivr (better CORS support) -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-is@18.3.1/umd/react-is.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } = Recharts;

    // Icons
    const Plus = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Trash2 = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const Edit2 = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    );

    const Pause = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="6" y="4" width="4" height="16"></rect>
        <rect x="14" y="4" width="4" height="16"></rect>
      </svg>
    );

    const Play = ({ size = 18 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
    );

    // Sample data
    const defaultSubscriptions = [
      { id: 1, name: 'Netflix', amount: 1980, cycle: 'monthly', nextBilling: '2026-01-20', category: '„Ç®„É≥„Çø„É°', color: '#64748b', satisfaction: 'È´ò', frequency: 'ÈÄ±1', isActive: true },
      { id: 2, name: 'Adobe CC', amount: 65760, cycle: 'yearly', nextBilling: '2026-03-15', category: '‰ªï‰∫ã', color: '#0ea5e9', satisfaction: 'È´ò', frequency: 'ÊØéÊó•', isActive: true },
      { id: 3, name: 'Spotify', amount: 980, cycle: 'monthly', nextBilling: '2026-01-18', category: '„Ç®„É≥„Çø„É°', color: '#64748b', satisfaction: '‰∏≠', frequency: 'ÊØéÊó•', isActive: true },
      { id: 4, name: '„Ç∏„É†‰ºöÂì°', amount: 8800, cycle: 'monthly', nextBilling: '2026-01-25', category: 'ÂÅ•Â∫∑', color: '#f59e0b', satisfaction: '‰Ωé', frequency: '„Åª„ÅºÊú™‰ΩøÁî®', isActive: true },
      { id: 5, name: 'Claude Pro', amount: 3000, cycle: 'monthly', nextBilling: '2026-01-22', category: '‰ªï‰∫ã', color: '#0ea5e9', satisfaction: 'È´ò', frequency: 'ÊØéÊó•', isActive: true }
    ];

    function App() {
      const categories = ['„Ç®„É≥„Çø„É°', '‰ªï‰∫ã', 'ÂÅ•Â∫∑', 'ÊïôËÇ≤', 'ÁîüÊ¥ª', '„Åù„ÅÆ‰ªñ'];
      const colors = ['#64748b', '#0ea5e9', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
      const satisfactionLevels = ['È´ò', '‰∏≠', '‰Ωé'];
      const satisfactionColors = { 'È´ò': '#10b981', '‰∏≠': '#f59e0b', '‰Ωé': '#ef4444' };
      const frequencyLevels = ['ÊØéÊó•', 'ÈÄ±1', 'Êúà1', '„Åª„ÅºÊú™‰ΩøÁî®'];

      const [subscriptions, setSubscriptions] = useState(() => {
        const saved = localStorage.getItem('subscriptions_pwa');
        return saved ? JSON.parse(saved) : defaultSubscriptions;
      });

      const [history, setHistory] = useState(() => {
        const saved = localStorage.getItem('history_pwa');
        return saved ? JSON.parse(saved) : [];
      });

      const [showForm, setShowForm] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [activeTab, setActiveTab] = useState('list');
      const [displayMode, setDisplayMode] = useState('monthly'); // 'monthly' or 'yearly'

      const [formData, setFormData] = useState({
        name: '', amount: '', cycle: 'monthly', nextBilling: '', category: '„Åù„ÅÆ‰ªñ',
        color: '#06b6d4', satisfaction: '‰∏≠', frequency: 'ÈÄ±1', isActive: true
      });

      // Save to localStorage
      useEffect(() => {
        localStorage.setItem('subscriptions_pwa', JSON.stringify(subscriptions));
      }, [subscriptions]);

      useEffect(() => {
        localStorage.setItem('history_pwa', JSON.stringify(history));
      }, [history]);

      const getDaysUntilBilling = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const billing = new Date(date);
        billing.setHours(0, 0, 0, 0);
        return Math.ceil((billing - today) / (1000 * 60 * 60 * 24));
      };

      const getUrgencyColor = (days) => {
        if (days < 0) return 'bg-gray-400';
        if (days <= 7) return 'bg-rose-400';
        if (days <= 14) return 'bg-amber-400';
        if (days <= 30) return 'bg-yellow-400';
        return 'bg-emerald-400';
      };

      const getMonthlyAmount = (sub) => sub.cycle === 'yearly' ? Math.round(sub.amount / 12) : sub.amount;

      const getCancelScore = (sub) => {
        const satScore = { 'È´ò': 0, '‰∏≠': 1, '‰Ωé': 2 };
        const freqScore = { 'ÊØéÊó•': 0, 'ÈÄ±1': 1, 'Êúà1': 2, '„Åª„ÅºÊú™‰ΩøÁî®': 3 };
        return satScore[sub.satisfaction] + freqScore[sub.frequency];
      };

      const getCancelRecommendation = (score) => {
        if (score >= 4) return { label: 'Ëß£Á¥ÑÊ§úË®é', color: 'bg-rose-100 text-rose-700' };
        if (score >= 3) return { label: 'Ë¶ÅÁ¢∫Ë™ç', color: 'bg-amber-100 text-amber-700' };
        if (score >= 2) return { label: 'ÊßòÂ≠êË¶ã', color: 'bg-yellow-100 text-yellow-700' };
        return { label: 'Á∂ôÁ∂ö', color: 'bg-emerald-100 text-emerald-700' };
      };

      const getCardBackground = (score) => {
        if (score >= 4) return 'linear-gradient(135deg, #fff5f5 0%, #ffe4e6 100%)';
        if (score >= 3) return 'linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)';
        return 'white';
      };

      const activeSubs = subscriptions.filter(s => s.isActive);
      const pausedSubs = subscriptions.filter(s => !s.isActive);
      const totalMonthly = activeSubs.reduce((sum, sub) => sum + getMonthlyAmount(sub), 0);
      const totalYearly = activeSubs.reduce((sum, sub) => sum + (sub.cycle === 'yearly' ? sub.amount : sub.amount * 12), 0);
      const potentialSavings = activeSubs.filter(sub => getCancelScore(sub) >= 4).reduce((sum, sub) => sum + getMonthlyAmount(sub), 0);

      // „Ç´„ÉÜ„Ç¥„É™Âà•„ÉªÊ∫ÄË∂≥Â∫¶Âà•„Éá„Éº„Çø
      const categoryData = categories.map((cat, idx) => {
        const total = activeSubs.filter(s => s.category === cat).reduce((sum, s) => sum + getMonthlyAmount(s), 0);
        return { name: cat, value: total, color: colors[idx] };
      }).filter(d => d.value > 0);

      const satisfactionData = satisfactionLevels.map(sat => {
        const total = activeSubs.filter(s => s.satisfaction === sat).reduce((sum, s) => sum + getMonthlyAmount(s), 0);
        return { name: `Ê∫ÄË∂≥Â∫¶: ${sat}`, value: total, color: satisfactionColors[sat] };
      }).filter(d => d.value > 0);

      const getMatrixData = () => {
        const matrix = {};
        satisfactionLevels.forEach(sat => {
          matrix[sat] = {};
          frequencyLevels.forEach(freq => {
            matrix[sat][freq] = activeSubs.filter(sub => sub.satisfaction === sat && sub.frequency === freq);
          });
        });
        return matrix;
      };

      const getMatrixCellColor = (sat, freq) => {
        const score = satisfactionLevels.indexOf(sat) + frequencyLevels.indexOf(freq);
        if (score >= 4) return 'bg-rose-50 border-rose-200';
        if (score >= 3) return 'bg-amber-50 border-amber-200';
        if (score >= 2) return 'bg-yellow-50 border-yellow-200';
        return 'bg-emerald-50 border-emerald-200';
      };

      const toggleStatus = (id) => {
        const sub = subscriptions.find(s => s.id === id);
        const newStatus = !sub.isActive;
        setHistory([{ id: Date.now() + Math.random(), subId: id, subName: sub.name, action: newStatus ? 'ÂÜçÂ•ëÁ¥Ñ' : 'Ëß£Á¥Ñ', date: new Date().toISOString().split('T')[0], amount: sub.amount, cycle: sub.cycle }, ...history]);
        setSubscriptions(subscriptions.map(s => s.id === id ? { ...s, isActive: newStatus } : s));
      };

      const handleSubmit = () => {
        // ÂÖ•ÂäõÂÄ§„ÅÆÊ§úË®º
        if (!formData.name || !formData.name.trim()) {
          alert('„Çµ„Éº„Éì„ÇπÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }
        if (!formData.amount || formData.amount === '' || formData.amount <= 0) {
          alert('ÈáëÈ°ç„ÅØ1ÂÜÜ‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }
        if (!formData.nextBilling) {
          alert('Ê¨°ÂõûË´ãÊ±ÇÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }

        const numAmount = typeof formData.amount === 'string' ? Number(formData.amount) : formData.amount;
        const validatedData = { ...formData, amount: numAmount };

        if (editingId) {
          setSubscriptions(subscriptions.map(sub => sub.id === editingId ? { ...validatedData, id: editingId } : sub));
          setEditingId(null);
        } else {
          const newSub = { ...validatedData, id: Date.now() + Math.random() };
          setSubscriptions([...subscriptions, newSub]);
          setHistory([{ id: Date.now() + Math.random(), subId: newSub.id, subName: newSub.name, action: 'Êñ∞Ë¶èÂ•ëÁ¥Ñ', date: new Date().toISOString().split('T')[0], amount: newSub.amount, cycle: newSub.cycle }, ...history]);
        }
        resetForm();
      };

      const handleEdit = (sub) => {
        setFormData({ ...sub });
        setEditingId(sub.id);
        setShowForm(true);
        setActiveTab('list');
      };

      const handleDelete = (id) => {
        if (confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
          setSubscriptions(subscriptions.filter(sub => sub.id !== id));
          setHistory(history.filter(h => h.subId !== id));
        }
      };

      const resetForm = () => {
        setFormData({ name: '', amount: '', cycle: 'monthly', nextBilling: '', category: '„Åù„ÅÆ‰ªñ', color: '#06b6d4', satisfaction: '‰∏≠', frequency: 'ÈÄ±1', isActive: true });
        setShowForm(false);
        setEditingId(null);
      };

      const sortedSubs = [...activeSubs].sort((a, b) => getDaysUntilBilling(a.nextBilling) - getDaysUntilBilling(b.nextBilling));

      const CustomTooltip = ({ active, payload }) => {
        if (active && payload && payload.length) {
          return (
            <div className="bg-white p-2 border rounded shadow-lg text-sm">
              <p className="font-medium">{payload[0].name}</p>
              <p className="text-gray-600">ÊúàÊèõÁÆó ¬•{payload[0].value.toLocaleString()}</p>
            </div>
          );
        }
        return null;
      };

      return (
        <div className="min-h-screen bg-gray-50 p-3 pb-20">
          <div className="max-w-lg mx-auto">
            {/* Header */}
            <div className="bg-white rounded-2xl shadow-lg p-4 mb-3">
              <div className="flex justify-between items-center mb-3">
                <div>
                  <h1 className="text-xl font-bold text-gray-900">„Çµ„Éñ„Çπ„ÇØÁÆ°ÁêÜ</h1>
                  <p className="text-gray-500 text-xs">Ê∫ÄË∂≥Â∫¶√óÈ†ªÂ∫¶„ÅßÊúÄÈÅ©Âåñ</p>
                </div>
                <button onClick={() => { setShowForm(!showForm); if (showForm) resetForm(); }} className="bg-slate-700 hover:bg-slate-800 text-white px-3 py-2 rounded-lg flex items-center gap-1 text-sm">
                  <Plus />
                  {showForm ? 'Èñâ„Åò„Çã' : 'ËøΩÂä†'}
                </button>
              </div>

              {/* Display Mode Toggle */}
              <div className="flex justify-center gap-1 mb-3">
                <button
                  onClick={() => setDisplayMode('monthly')}
                  className={`px-4 py-1.5 rounded-lg text-xs font-medium transition-colors ${displayMode === 'monthly' ? 'bg-slate-700 text-white' : 'bg-gray-100 text-gray-600'}`}
                >
                  ÊúàÈ°çË°®Á§∫
                </button>
                <button
                  onClick={() => setDisplayMode('yearly')}
                  className={`px-4 py-1.5 rounded-lg text-xs font-medium transition-colors ${displayMode === 'yearly' ? 'bg-slate-700 text-white' : 'bg-gray-100 text-gray-600'}`}
                >
                  Âπ¥È°çË°®Á§∫
                </button>
              </div>

              {/* Stats */}
              <div className="grid grid-cols-2 gap-2 mb-3">
                <div className="bg-slate-100 rounded-xl p-3">
                  <p className="text-slate-600 text-xs">{displayMode === 'monthly' ? 'ÊúàÈ°ç' : 'Âπ¥È°ç'}ÂêàË®à</p>
                  <p className="text-lg font-bold text-slate-800">¬•{(displayMode === 'monthly' ? totalMonthly : totalYearly).toLocaleString()}</p>
                </div>
                <div className="bg-blue-50 rounded-xl p-3">
                  <p className="text-blue-600 text-xs">{displayMode === 'monthly' ? 'Âπ¥Èñì' : 'ÊúàÊèõÁÆó'}Ë©¶ÁÆó</p>
                  <p className="text-lg font-bold text-blue-800">¬•{(displayMode === 'monthly' ? totalYearly : Math.round(totalYearly / 12)).toLocaleString()}</p>
                </div>
                <div className="bg-emerald-50 rounded-xl p-3">
                  <p className="text-emerald-600 text-xs">Â•ëÁ¥Ñ‰∏≠</p>
                  <p className="text-lg font-bold text-emerald-800">{activeSubs.length}‰ª∂</p>
                </div>
                <div className="bg-rose-50 rounded-xl p-3">
                  <p className="text-rose-600 text-xs">üí° ÂâäÊ∏õÂèØËÉΩ</p>
                  <p className="text-lg font-bold text-rose-800">¬•{(displayMode === 'monthly' ? potentialSavings : potentialSavings * 12).toLocaleString()}</p>
                </div>
              </div>

            </div>

            {/* Content */}
            <div className="bg-white rounded-2xl shadow-lg">
              <div className="p-4">
                {/* List */}
                {activeTab === 'list' && (
                  <div className="space-y-2">
                    {sortedSubs.map(sub => {
                      const days = getDaysUntilBilling(sub.nextBilling);
                      const score = getCancelScore(sub);
                      const rec = getCancelRecommendation(score);
                      return (
                        <div key={sub.id} className="border rounded-xl p-3 transition-all" style={{ borderLeftWidth: 4, borderLeftColor: sub.color, background: getCardBackground(score) }}>
                          {/* Top row: Name | Days | Badge */}
                          <div className="flex justify-between items-center mb-2">
                            <span className="font-semibold text-sm truncate flex-shrink">{sub.name}</span>
                            <span className={`text-xs px-2 py-1 ${getUrgencyColor(days)} text-white rounded font-medium mx-2 whitespace-nowrap`}>
                              {days < 0 ? 'ÊúüÈôêÂàá„Çå' : days === 0 ? '‰ªäÊó•' : `${days}Êó•Âæå`}
                            </span>
                            <span className={`text-xs px-2 py-1 rounded-full ${rec.color} font-medium whitespace-nowrap`}>{rec.label}</span>
                          </div>
                          {/* Bottom row: Amount & Details | Actions */}
                          <div className="flex justify-between items-center">
                            <div className="flex-1">
                              <div className="text-sm font-semibold text-gray-900">
                                ¬•{sub.amount.toLocaleString()}/{sub.cycle === 'monthly' ? 'Êúà' : 'Âπ¥'}
                              </div>
                              <div className="flex items-center gap-2 mt-0.5 text-xs text-gray-600">
                                <span>Ê∫ÄË∂≥Â∫¶:{sub.satisfaction}</span>
                                <span>‚Ä¢</span>
                                <span>‰ΩøÁî®:{sub.frequency}</span>
                              </div>
                            </div>
                            <div className="flex gap-0.5 ml-2">
                              <button onClick={() => toggleStatus(sub.id)} className="p-1.5 text-amber-600 hover:bg-amber-50 rounded" title="ÂÅúÊ≠¢"><Pause size={16} /></button>
                              <button onClick={() => handleEdit(sub)} className="p-1.5 text-slate-600 hover:bg-slate-50 rounded" title="Á∑®ÈõÜ"><Edit2 size={16} /></button>
                              <button onClick={() => handleDelete(sub.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded" title="ÂâäÈô§"><Trash2 size={16} /></button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                    {pausedSubs.length > 0 && (
                      <>
                        <p className="text-xs font-medium text-gray-500 mt-3">ÂÅúÊ≠¢‰∏≠ ({pausedSubs.length}‰ª∂)</p>
                        {pausedSubs.map(sub => (
                          <div key={sub.id} className="border rounded-xl p-2 bg-gray-50 opacity-70">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-600">{sub.name}</span>
                              <div className="flex gap-0.5">
                                <button onClick={() => toggleStatus(sub.id)} className="p-1 text-emerald-600"><Play size={14} /></button>
                                <button onClick={() => handleDelete(sub.id)} className="p-1 text-rose-600"><Trash2 size={14} /></button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </>
                    )}
                  </div>
                )}

                {/* Matrix */}
                {activeTab === 'matrix' && (
                  <div>
                    <p className="text-xs text-gray-600 mb-2">Âè≥‰∏ã„Åª„Å©Ëß£Á¥ÑÂÑ™ÂÖàÂ∫¶„ÅåÈ´ò„ÅÑ</p>
                    <div className="overflow-x-auto -mx-4 px-4">
                      <table className="w-full min-w-[400px] text-xs">
                        <thead>
                          <tr>
                            <th className="p-1 text-left w-16"></th>
                            {frequencyLevels.map(f => <th key={f} className="p-1 text-center font-medium text-gray-700">{f}</th>)}
                          </tr>
                        </thead>
                        <tbody>
                          {satisfactionLevels.map(sat => (
                            <tr key={sat}>
                              <td className="p-1 font-medium text-gray-700 text-xs">Ê∫ÄË∂≥:{sat}</td>
                              {frequencyLevels.map(freq => {
                                const subs = getMatrixData()[sat][freq];
                                return (
                                  <td key={freq} className={`p-1 border ${getMatrixCellColor(sat, freq)} align-top`}>
                                    {subs.map(sub => (
                                      <div key={sub.id} onClick={() => handleEdit(sub)} className="bg-white rounded p-1 mb-0.5 shadow-sm cursor-pointer text-xs">
                                        <p className="font-medium truncate">{sub.name}</p>
                                        <p className="text-gray-500">¬•{getMonthlyAmount(sub).toLocaleString()}</p>
                                      </div>
                                    ))}
                                    {subs.length === 0 && <span className="text-gray-300">-</span>}
                                  </td>
                                );
                              })}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Analysis */}
                {activeTab === 'analysis' && (
                  <div className="space-y-4">
                    <div>
                      <h3 className="text-sm font-bold text-gray-900 mb-2">„Ç´„ÉÜ„Ç¥„É™Âà•ÔºàÊúàÈ°çÔºâ</h3>
                      <div className="h-48">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={categoryData} cx="50%" cy="50%" innerRadius={30} outerRadius={60} paddingAngle={2} dataKey="value">
                              {categoryData.map((entry, index) => <Cell key={index} fill={entry.color} />)}
                            </Pie>
                            <Tooltip content={<CustomTooltip />} />
                            <Legend wrapperStyle={{fontSize: '11px'}} />
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                    <div>
                      <h3 className="text-sm font-bold text-gray-900 mb-2">Ê∫ÄË∂≥Â∫¶Âà•ÔºàÊúàÈ°çÔºâ</h3>
                      <div className="h-48">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={satisfactionData} cx="50%" cy="50%" innerRadius={30} outerRadius={60} paddingAngle={2} dataKey="value">
                              {satisfactionData.map((entry, index) => <Cell key={index} fill={entry.color} />)}
                            </Pie>
                            <Tooltip content={<CustomTooltip />} />
                            <Legend wrapperStyle={{fontSize: '11px'}} />
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                    <div className="bg-slate-50 rounded-xl p-3">
                      <h3 className="text-sm font-bold mb-2">üí° ÊúÄÈÅ©Âåñ„Çµ„Éû„É™„Éº</h3>
                      <div className="grid grid-cols-3 gap-2 text-center">
                        <div>
                          <p className="text-xs text-gray-500">Ê∫ÄË∂≥Â∫¶„Äå‰Ωé„Äç</p>
                          <p className="font-bold text-rose-600">¬•{activeSubs.filter(s => s.satisfaction === '‰Ωé').reduce((sum, s) => sum + getMonthlyAmount(s), 0).toLocaleString()}</p>
                        </div>
                        <div>
                          <p className="text-xs text-gray-500">„Åª„ÅºÊú™‰ΩøÁî®</p>
                          <p className="font-bold text-amber-600">¬•{activeSubs.filter(s => s.frequency === '„Åª„ÅºÊú™‰ΩøÁî®').reduce((sum, s) => sum + getMonthlyAmount(s), 0).toLocaleString()}</p>
                        </div>
                        <div>
                          <p className="text-xs text-gray-500">Âπ¥ÈñìÂâäÊ∏õ</p>
                          <p className="font-bold text-emerald-600">¬•{(potentialSavings * 12).toLocaleString()}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* History - Timeline */}
                {activeTab === 'history' && (
                  <div className="relative">
                    {history.length > 0 ? (
                      <div className="relative">
                        {/* Timeline line */}
                        <div className="absolute left-3 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                        {history.slice(0, 20).map((h, idx) => (
                          <div key={h.id} className="relative pl-10 pb-4">
                            {/* Timeline dot */}
                            <div className={`absolute left-1.5 top-1 w-3 h-3 rounded-full ${h.action === 'Ëß£Á¥Ñ' ? 'bg-amber-400' : h.action === 'ÂÜçÂ•ëÁ¥Ñ' ? 'bg-emerald-400' : 'bg-blue-400'}`}></div>
                            {/* Content */}
                            <div className="bg-white rounded-lg p-3 shadow-sm border">
                              <div className="flex justify-between items-start mb-1">
                                <div className="flex items-center gap-2">
                                  <span className={`px-2 py-0.5 rounded text-xs font-medium ${h.action === 'Ëß£Á¥Ñ' ? 'bg-amber-100 text-amber-800' : h.action === 'ÂÜçÂ•ëÁ¥Ñ' ? 'bg-emerald-100 text-emerald-800' : 'bg-blue-100 text-blue-800'}`}>
                                    {h.action}
                                  </span>
                                  <span className="font-semibold text-sm">{h.subName}</span>
                                </div>
                                <span className="text-gray-400 text-xs">{h.date}</span>
                              </div>
                              <p className="text-gray-500 text-xs">
                                ¬•{h.amount.toLocaleString()} / {h.cycle === 'monthly' ? 'Êúà' : 'Âπ¥'}
                              </p>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-center text-gray-400 py-8 text-sm">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Bottom Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-10">
            <div className="max-w-lg mx-auto flex">
              {[
                { id: 'list', label: '‰∏ÄË¶ß', icon: 'üìã' },
                { id: 'matrix', label: '„Éû„Éà„É™„ÇØ„Çπ', icon: 'üìä' },
                { id: 'analysis', label: 'ÂàÜÊûê', icon: 'üìà' },
                { id: 'history', label: 'Â±•Ê≠¥', icon: 'üìú' }
              ].map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-3 text-center ${activeTab === tab.id ? 'text-slate-700 font-medium' : 'text-gray-400'}`}>
                  <div className="text-lg">{tab.icon}</div>
                  <div className="text-xs">{tab.label}</div>
                </button>
              ))}
            </div>
          </div>

          {/* Modal Form */}
          {showForm && (
            <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50" onClick={resetForm}>
              <div className="bg-white rounded-2xl p-5 max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold text-gray-900">{editingId ? '„Çµ„Éñ„Çπ„ÇØÁ∑®ÈõÜ' : '„Çµ„Éñ„Çπ„ÇØËøΩÂä†'}</h2>
                  <button onClick={resetForm} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div className="space-y-3">
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">„Çµ„Éº„Éì„ÇπÂêç *</label>
                    <input type="text" placeholder="Netflix" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent" required />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">ÈáëÈ°ç *</label>
                      <input type="text" inputMode="numeric" placeholder="1980" value={formData.amount} onChange={(e) => { const val = e.target.value.replace(/[^\d]/g, ''); setFormData({...formData, amount: val === '' ? '' : Math.max(0, Number(val)) }); }} className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent" required />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">Âë®Êúü</label>
                      <select value={formData.cycle} onChange={(e) => setFormData({...formData, cycle: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent">
                        <option value="monthly">ÊúàÈ°ç</option>
                        <option value="yearly">Âπ¥È°ç</option>
                      </select>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">Ê¨°ÂõûË´ãÊ±ÇÊó• *</label>
                      <input type="date" value={formData.nextBilling} onChange={(e) => setFormData({...formData, nextBilling: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent" required />
                    </div>
                    <div>
                      <label className="block text-xs font-medium text-gray-700 mb-1">„Ç´„ÉÜ„Ç¥„É™</label>
                      <select value={formData.category} onChange={(e) => { const cat = e.target.value; setFormData({...formData, category: cat, color: colors[categories.indexOf(cat)] || '#06b6d4'}); }} className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent">
                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Ê∫ÄË∂≥Â∫¶</label>
                    <select value={formData.satisfaction} onChange={(e) => setFormData({...formData, satisfaction: e.target.value})} className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent">
                      {satisfactionLevels.map(s => <option key={s} value={s}>Ê∫ÄË∂≥Â∫¶: {s}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">‰ΩøÁî®È†ªÂ∫¶</label>
                    <div className="flex gap-2 flex-wrap">
                      {frequencyLevels.map(f => (
                        <button key={f} type="button" onClick={() => setFormData({...formData, frequency: f})} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${formData.frequency === f ? 'bg-slate-700 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>{f}</button>
                      ))}
                    </div>
                  </div>
                  <button onClick={handleSubmit} className="mt-4 w-full bg-slate-700 hover:bg-slate-800 text-white py-3 rounded-lg text-sm font-medium transition-colors">
                    {editingId ? 'Êõ¥Êñ∞„Åô„Çã' : 'ËøΩÂä†„Åô„Çã'}
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Service Worker ÁôªÈå≤
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(console.error);
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
