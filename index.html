<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#334155">
  <meta name="description" content="ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’æº€è¶³åº¦ã¨ä½¿ç”¨é »åº¦ã§ç®¡ç†ã—ã€è§£ç´„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æœ€é©åŒ–">
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†">
  <title>ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†</title>
  
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Recharts (ã‚°ãƒ©ãƒ•æç”») & prop-types via jsDelivr -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-is@18.3.1/umd/react-is.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } = Recharts;

    // Icons
    const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const Trash2 = ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
    const Edit2 = ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
    const Pause = ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
    const Play = ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
    const Download = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
    const Upload = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
    const Settings = ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;

    // Sample data
    const defaultSubscriptions = [
      { id: 1, name: 'Netflix', amount: 1980, cycle: 'monthly', nextBilling: '2026-01-20', category: 'ã‚¨ãƒ³ã‚¿ãƒ¡', color: '#64748b', satisfaction: 'é«˜', frequency: 'é€±1', isActive: true },
      { id: 2, name: 'Adobe CC', amount: 65760, cycle: 'yearly', nextBilling: '2026-03-15', category: 'ä»•äº‹', color: '#0ea5e9', satisfaction: 'é«˜', frequency: 'æ¯æ—¥', isActive: true },
    ];

    function App() {
      const categories = ['ã‚¨ãƒ³ã‚¿ãƒ¡', 'ä»•äº‹', 'å¥åº·', 'æ•™è‚²', 'ç”Ÿæ´»', 'ãã®ä»–'];
      const colors = ['#64748b', '#0ea5e9', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
      const satisfactionLevels = ['é«˜', 'ä¸­', 'ä½'];
      const satisfactionColors = { 'é«˜': '#10b981', 'ä¸­': '#f59e0b', 'ä½': '#ef4444' };
      const frequencyLevels = ['æ¯æ—¥', 'é€±1', 'æœˆ1', 'ã»ã¼æœªä½¿ç”¨'];

      const [subscriptions, setSubscriptions] = useState(() => {
        const saved = localStorage.getItem('subscriptions_pwa');
        return saved ? JSON.parse(saved) : defaultSubscriptions;
      });

      const [history, setHistory] = useState(() => {
        const saved = localStorage.getItem('history_pwa');
        return saved ? JSON.parse(saved) : [];
      });

      const [showForm, setShowForm] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [activeTab, setActiveTab] = useState('list');
      const fileInputRef = useRef(null);

      const [formData, setFormData] = useState({
        name: '', amount: '', cycle: 'monthly', nextBilling: '', category: 'ãã®ä»–',
        color: '#06b6d4', satisfaction: 'ä¸­', frequency: 'é€±1', isActive: true
      });

      // Save to localStorage
      useEffect(() => {
        localStorage.setItem('subscriptions_pwa', JSON.stringify(subscriptions));
      }, [subscriptions]);

      useEffect(() => {
        localStorage.setItem('history_pwa', JSON.stringify(history));
      }, [history]);

      // --- Backup / Restore Functions ---
      
      // 1. ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãå‡ºã—
      const handleExport = () => {
        const data = {
          subscriptions,
          history,
          exportedAt: new Date().toISOString(),
          app: 'subscription-manager-pwa'
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `subs_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // 2. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
      const handleImportClick = () => {
        fileInputRef.current.click();
      };

      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.app === 'subscription-manager-pwa' && Array.isArray(data.subscriptions)) {
              if (confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆ${data.exportedAt.slice(0, 10)}ä½œæˆï¼‰ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                setSubscriptions(data.subscriptions);
                setHistory(data.history || []);
                alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                setActiveTab('list');
              }
            } else {
              alert('ã‚¨ãƒ©ãƒ¼ï¼šæ­£ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
          } catch (err) {
            alert('ã‚¨ãƒ©ãƒ¼ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            console.error(err);
          }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset input
      };

      // 3. ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
      const handleResetAll = () => {
        if (confirm('ã€è­¦å‘Šã€‘ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
          setSubscriptions(defaultSubscriptions);
          setHistory([]);
          alert('åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚');
        }
      };

      // --- Helper Functions ---
      const getDaysUntilBilling = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const billing = new Date(date);
        billing.setHours(0, 0, 0, 0);
        return Math.ceil((billing - today) / (1000 * 60 * 60 * 24));
      };

      const getUrgencyColor = (days) => {
        if (days < 0) return 'bg-gray-400';
        if (days <= 7) return 'bg-rose-400';
        if (days <= 14) return 'bg-amber-400';
        if (days <= 30) return 'bg-yellow-400';
        return 'bg-emerald-400';
      };

      const getMonthlyAmount = (sub) => sub.cycle === 'yearly' ? Math.round(sub.amount / 12) : sub.amount;

      const getCancelScore = (sub) => {
        const satScore = { 'é«˜': 0, 'ä¸­': 1, 'ä½': 2 };
        const freqScore = { 'æ¯æ—¥': 0, 'é€±1': 1, 'æœˆ1': 2, 'ã»ã¼æœªä½¿ç”¨': 3 };
        return satScore[sub.satisfaction] + freqScore[sub.frequency];
      };

      const getCancelRecommendation = (score) => {
        if (score >= 4) return { label: 'è§£ç´„æ¤œè¨', color: 'bg-rose-100 text-rose-700' };
        if (score >= 3) return { label: 'è¦ç¢ºèª', color: 'bg-amber-100 text-amber-700' };
        if (score >= 2) return { label: 'æ§˜å­è¦‹', color: 'bg-yellow-100 text-yellow-700' };
        return { label: 'ç¶™ç¶š', color: 'bg-emerald-100 text-emerald-700' };
      };

      const activeSubs = subscriptions.filter(s => s.isActive);
      const pausedSubs = subscriptions.filter(s => !s.isActive);
      const totalMonthly = activeSubs.reduce((sum, sub) => sum + getMonthlyAmount(sub), 0);
      const totalYearly = activeSubs.reduce((sum, sub) => sum + (sub.cycle === 'yearly' ? sub.amount : sub.amount * 12), 0);
      const potentialSavings = activeSubs.filter(sub => getCancelScore(sub) >= 4).reduce((sum, sub) => sum + getMonthlyAmount(sub), 0);

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ»æº€è¶³åº¦åˆ¥ãƒ‡ãƒ¼ã‚¿
      const categoryData = categories.map((cat, idx) => {
        const total = activeSubs.filter(s => s.category === cat).reduce((sum, s) => sum + getMonthlyAmount(s), 0);
        return { name: cat, value: total, color: colors[idx] };
      }).filter(d => d.value > 0);

      const satisfactionData = satisfactionLevels.map(sat => {
        const total = activeSubs.filter(s => s.satisfaction === sat).reduce((sum, s) => sum + getMonthlyAmount(s), 0);
        return { name: `æº€è¶³åº¦: ${sat}`, value: total, color: satisfactionColors[sat] };
      }).filter(d => d.value > 0);

      const getMatrixData = () => {
        const matrix = {};
        satisfactionLevels.forEach(sat => {
          matrix[sat] = {};
          frequencyLevels.forEach(freq => {
            matrix[sat][freq] = activeSubs.filter(sub => sub.satisfaction === sat && sub.frequency === freq);
          });
        });
        return matrix;
      };

      const getMatrixCellColor = (sat, freq) => {
        const score = satisfactionLevels.indexOf(sat) + frequencyLevels.indexOf(freq);
        if (score >= 4) return 'bg-rose-50 border-rose-200';
        if (score >= 3) return 'bg-amber-50 border-amber-200';
        if (score >= 2) return 'bg-yellow-50 border-yellow-200';
        return 'bg-emerald-50 border-emerald-200';
      };

      const toggleStatus = (id) => {
        const sub = subscriptions.find(s => s.id === id);
        const newStatus = !sub.isActive;
        setHistory([{ id: Date.now() + Math.random(), subId: id, subName: sub.name, action: newStatus ? 'å†å¥‘ç´„' : 'è§£ç´„', date: new Date().toISOString().split('T')[0], amount: sub.amount, cycle: sub.cycle }, ...history]);
        setSubscriptions(subscriptions.map(s => s.id === id ? { ...s, isActive: newStatus } : s));
      };

      const handleSubmit = () => {
        // å…¥åŠ›å€¤ã®æ¤œè¨¼
        if (!formData.name || !formData.name.trim()) {
          alert('ã‚µãƒ¼ãƒ“ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        if (!formData.amount || formData.amount === '' || formData.amount <= 0) {
          alert('é‡‘é¡ã¯1å††ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        if (!formData.nextBilling) {
          alert('æ¬¡å›è«‹æ±‚æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        const numAmount = typeof formData.amount === 'string' ? Number(formData.amount) : formData.amount;
        const validatedData = { ...formData, amount: numAmount };

        if (editingId) {
          setSubscriptions(subscriptions.map(sub => sub.id === editingId ? { ...validatedData, id: editingId } : sub));
          setEditingId(null);
        } else {
          const newSub = { ...validatedData, id: Date.now() + Math.random() };
          setSubscriptions([...subscriptions, newSub]);
          setHistory([{ id: Date.now() + Math.random(), subId: newSub.id, subName: newSub.name, action: 'æ–°è¦å¥‘ç´„', date: new Date().toISOString().split('T')[0], amount: newSub.amount, cycle: newSub.cycle }, ...history]);
        }
        resetForm();
      };

      const handleEdit = (sub) => {
        setFormData({ ...sub });
        setEditingId(sub.id);
        setShowForm(true);
        setActiveTab('list');
      };

      const handleDelete = (id) => {
        if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          setSubscriptions(subscriptions.filter(sub => sub.id !== id));
          setHistory(history.filter(h => h.subId !== id));
        }
      };

      const resetForm = () => {
        setFormData({ name: '', amount: '', cycle: 'monthly', nextBilling: '', category: 'ãã®ä»–', color: '#06b6d4', satisfaction: 'ä¸­', frequency: 'é€±1', isActive: true });
        setShowForm(false);
        setEditingId(null);
      };

      const sortedSubs = [...activeSubs].sort((a, b) => getDaysUntilBilling(a.nextBilling) - getDaysUntilBilling(b.nextBilling));

      const CustomTooltip = ({ active, payload }) => {
        if (active && payload && payload.length) {
          return (
            <div className="bg-white p-2 border rounded shadow-lg text-sm">
              <p className="font-medium">{payload[0].name}</p>
              <p className="text-gray-600">æœˆæ›ç®— Â¥{payload[0].value.toLocaleString()}</p>
            </div>
          );
        }
        return null;
      };

      return (
        <div className="min-h-screen bg-gray-50 p-3 pb-24">
          <div className="max-w-lg mx-auto">
            {/* Header */}
            <div className="bg-white rounded-2xl shadow-lg p-4 mb-3">
              <div className="flex justify-between items-center mb-3">
                <div>
                  <h1 className="text-xl font-bold text-gray-900">ã‚µãƒ–ã‚¹ã‚¯ç®¡ç†</h1>
                  <p className="text-gray-500 text-xs">æº€è¶³åº¦Ã—é »åº¦ã§æœ€é©åŒ–</p>
                </div>
                {activeTab !== 'settings' && (
                  <button onClick={() => { setShowForm(!showForm); if (showForm) resetForm(); }} className="bg-slate-700 hover:bg-slate-800 text-white px-3 py-2 rounded-lg flex items-center gap-1 text-sm">
                    <Plus />
                    {showForm ? 'é–‰ã˜ã‚‹' : 'è¿½åŠ '}
                  </button>
                )}
              </div>

              {/* Stats */}
              {activeTab === 'list' && !showForm && (
                <div className="grid grid-cols-2 gap-2 mb-3">
                  <div className="bg-slate-100 rounded-xl p-3">
                    <p className="text-slate-600 text-xs">æœˆé¡åˆè¨ˆ</p>
                    <p className="text-lg font-bold text-slate-800">Â¥{totalMonthly.toLocaleString()}</p>
                  </div>
                  <div className="bg-blue-50 rounded-xl p-3">
                    <p className="text-blue-600 text-xs">å¹´é¡åˆè¨ˆ</p>
                    <p className="text-lg font-bold text-blue-800">Â¥{totalYearly.toLocaleString()}</p>
                  </div>
                  <div className="bg-emerald-50 rounded-xl p-3">
                    <p className="text-emerald-600 text-xs">å¥‘ç´„ä¸­</p>
                    <p className="text-lg font-bold text-emerald-800">{activeSubs.length}ä»¶</p>
                  </div>
                  <div className="bg-rose-50 rounded-xl p-3">
                    <p className="text-rose-600 text-xs">ğŸ’¡ å‰Šæ¸›å¯èƒ½</p>
                    <p className="text-lg font-bold text-rose-800">Â¥{potentialSavings.toLocaleString()}</p>
                  </div>
                </div>
              )}

              {/* Form */}
              {showForm && (
                <div className="bg-gray-50 rounded-xl p-3">
                  <div className="grid grid-cols-2 gap-2">
                    <input type="text" placeholder="ã‚µãƒ¼ãƒ“ã‚¹å" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="col-span-2 px-3 py-2 border rounded-lg text-sm" required />
                    <input type="text" inputMode="numeric" placeholder="é‡‘é¡" value={formData.amount} onChange={(e) => { const val = e.target.value.replace(/[^\d]/g, ''); setFormData({...formData, amount: val === '' ? '' : Math.max(0, parseInt(val)) }); }} className="px-3 py-2 border rounded-lg text-sm" required />
                    <select value={formData.cycle} onChange={(e) => setFormData({...formData, cycle: e.target.value})} className="px-3 py-2 border rounded-lg text-sm">
                      <option value="monthly">æœˆé¡</option>
                      <option value="yearly">å¹´é¡</option>
                    </select>
                    <input type="date" value={formData.nextBilling} onChange={(e) => setFormData({...formData, nextBilling: e.target.value})} className="px-3 py-2 border rounded-lg text-sm" required />
                    <select value={formData.category} onChange={(e) => { const cat = e.target.value; setFormData({...formData, category: cat, color: colors[categories.indexOf(cat)] || '#06b6d4'}); }} className="px-3 py-2 border rounded-lg text-sm">
                      {categories.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                    <select value={formData.satisfaction} onChange={(e) => setFormData({...formData, satisfaction: e.target.value})} className="col-span-2 px-3 py-2 border rounded-lg text-sm">
                      {satisfactionLevels.map(s => <option key={s} value={s}>æº€è¶³åº¦: {s}</option>)}
                    </select>
                  </div>
                  <div className="flex gap-1 mt-2 flex-wrap">
                    {frequencyLevels.map(f => (
                      <button key={f} type="button" onClick={() => setFormData({...formData, frequency: f})} className={`px-2 py-1 rounded text-xs ${formData.frequency === f ? 'bg-slate-700 text-white' : 'bg-white border'}`}>{f}</button>
                    ))}
                  </div>
                  <button onClick={handleSubmit} className="mt-2 w-full bg-slate-700 text-white py-2 rounded-lg text-sm">{editingId ? 'æ›´æ–°' : 'è¿½åŠ '}</button>
                </div>
              )}
            </div>

            {/* Content */}
            <div className="bg-white rounded-2xl shadow-lg">
              <div className="p-4">
                {/* List */}
                {activeTab === 'list' && (
                  <div className="space-y-2">
                    {sortedSubs.map(sub => {
                      const days = getDaysUntilBilling(sub.nextBilling);
                      const rec = getCancelRecommendation(getCancelScore(sub));
                      return (
                        <div key={sub.id} className="border rounded-xl p-3" style={{ borderLeftWidth: 4, borderLeftColor: sub.color }}>
                          <div className="flex justify-between items-start">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-1 flex-wrap mb-1">
                                <span className="font-semibold text-sm truncate">{sub.name}</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded-full ${rec.color}`}>{rec.label}</span>
                              </div>
                              <div className="text-sm text-gray-600">
                                Â¥{sub.amount.toLocaleString()}/{sub.cycle === 'monthly' ? 'æœˆ' : 'å¹´'}
                              </div>
                              <div className="flex items-center gap-1 mt-1 text-xs text-gray-500 flex-wrap">
                                <span className={`px-1.5 py-0.5 ${getUrgencyColor(days)} text-white rounded`}>
                                  {days < 0 ? 'æœŸé™åˆ‡ã‚Œ' : days === 0 ? 'ä»Šæ—¥' : `${days}æ—¥å¾Œ`}
                                </span>
                                <span>æº€è¶³:{sub.satisfaction}</span>
                                <span>é »åº¦:{sub.frequency}</span>
                              </div>
                            </div>
                            <div className="flex gap-0.5 ml-2">
                              <button onClick={() => toggleStatus(sub.id)} className="p-1.5 text-amber-600 hover:bg-amber-50 rounded"><Pause size={16} /></button>
                              <button onClick={() => handleEdit(sub)} className="p-1.5 text-slate-600 hover:bg-slate-50 rounded"><Edit2 size={16} /></button>
                              <button onClick={() => handleDelete(sub.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded"><Trash2 size={16} /></button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                    {pausedSubs.length > 0 && (
                      <>
                        <p className="text-xs font-medium text-gray-500 mt-3">åœæ­¢ä¸­ ({pausedSubs.length}ä»¶)</p>
                        {pausedSubs.map(sub => (
                          <div key={sub.id} className="border rounded-xl p-2 bg-gray-50 opacity-70">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-600">{sub.name}</span>
                              <div className="flex gap-0.5">
                                <button onClick={() => toggleStatus(sub.id)} className="p-1 text-emerald-600"><Play size={14} /></button>
                                <button onClick={() => handleDelete(sub.id)} className="p-1 text-rose-600"><Trash2 size={14} /></button>
                              </div>
                            </div>
                          </div>
                        ))}
                      </>
                    )}
                  </div>
                )}

                {/* Matrix */}
                {activeTab === 'matrix' && (
                  <div>
                    <p className="text-xs text-gray-600 mb-2">å³ä¸‹ã»ã©è§£ç´„å„ªå…ˆåº¦ãŒé«˜ã„</p>
                    <div className="overflow-x-auto -mx-4 px-4">
                      <table className="w-full min-w-[400px] text-xs">
                        <thead>
                          <tr>
                            <th className="p-1 text-left w-16"></th>
                            {frequencyLevels.map(f => <th key={f} className="p-1 text-center font-medium text-gray-700">{f}</th>)}
                          </tr>
                        </thead>
                        <tbody>
                          {satisfactionLevels.map(sat => (
                            <tr key={sat}>
                              <td className="p-1 font-medium text-gray-700 text-xs">æº€è¶³:{sat}</td>
                              {frequencyLevels.map(freq => {
                                const subs = getMatrixData()[sat][freq];
                                return (
                                  <td key={freq} className={`p-1 border ${getMatrixCellColor(sat, freq)} align-top`}>
                                    {subs.map(sub => (
                                      <div key={sub.id} onClick={() => handleEdit(sub)} className="bg-white rounded p-1 mb-0.5 shadow-sm cursor-pointer text-xs">
                                        <p className="font-medium truncate">{sub.name}</p>
                                        <p className="text-gray-500">Â¥{getMonthlyAmount(sub).toLocaleString()}</p>
                                      </div>
                                    ))}
                                    {subs.length === 0 && <span className="text-gray-300">-</span>}
                                  </td>
                                );
                              })}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Analysis */}
                {activeTab === 'analysis' && (
                  <div className="space-y-4">
                    <div>
                      <h3 className="text-sm font-bold text-gray-900 mb-2">ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆæœˆé¡ï¼‰</h3>
                      <div className="h-48">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={categoryData} cx="50%" cy="50%" innerRadius={30} outerRadius={60} paddingAngle={2} dataKey="value">
                              {categoryData.map((entry, index) => <Cell key={index} fill={entry.color} />)}
                            </Pie>
                            <Tooltip content={<CustomTooltip />} />
                            <Legend wrapperStyle={{fontSize: '11px'}} />
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                    <div>
                      <h3 className="text-sm font-bold text-gray-900 mb-2">æº€è¶³åº¦åˆ¥ï¼ˆæœˆé¡ï¼‰</h3>
                      <div className="h-48">
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={satisfactionData} cx="50%" cy="50%" innerRadius={30} outerRadius={60} paddingAngle={2} dataKey="value">
                              {satisfactionData.map((entry, index) => <Cell key={index} fill={entry.color} />)}
                            </Pie>
                            <Tooltip content={<CustomTooltip />} />
                            <Legend wrapperStyle={{fontSize: '11px'}} />
                          </PieChart>
                        </ResponsiveContainer>
                      </div>
                    </div>
                  </div>
                )}

                {/* History */}
                {activeTab === 'history' && (
                  <div className="space-y-2">
                    {history.length > 0 ? history.slice(0, 20).map(h => (
                      <div key={h.id} className={`rounded-lg p-2 text-sm ${h.action === 'è§£ç´„' ? 'bg-amber-50' : h.action === 'å†å¥‘ç´„' ? 'bg-emerald-50' : 'bg-blue-50'}`}>
                        <div className="flex justify-between items-center">
                          <div className="flex items-center gap-2">
                            <span className={`px-1.5 py-0.5 rounded text-xs font-medium ${h.action === 'è§£ç´„' ? 'bg-amber-200 text-amber-800' : h.action === 'å†å¥‘ç´„' ? 'bg-emerald-200 text-emerald-800' : 'bg-blue-200 text-blue-800'}`}>{h.action}</span>
                            <span className="font-medium">{h.subName}</span>
                          </div>
                          <span className="text-gray-500 text-xs">{h.date}</span>
                        </div>
                      </div>
                    )) : <p className="text-center text-gray-400 py-8 text-sm">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>}
                  </div>
                )}

                {/* Settings (Backup/Restore/Reset) */}
                {activeTab === 'settings' && (
                  <div className="space-y-4">
                    
                    {/* ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ */}
                    <div className="bg-white rounded-lg p-4 border border-gray-100">
                      <h3 className="font-bold text-gray-900 mb-2 flex items-center gap-2">
                        <Download size={18} />
                        ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                      </h3>
                      <p className="text-xs text-gray-500 mb-3">
                        ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚æ©Ÿç¨®å¤‰æ›´æ™‚ã‚„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ã«ãŠä½¿ã„ãã ã•ã„ã€‚
                      </p>
                      <button onClick={handleExport} className="w-full bg-slate-700 text-white py-2 rounded-lg text-sm font-bold flex justify-center items-center gap-2">
                        <Download size={16} />
                        ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                      </button>
                    </div>

                    {/* ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ */}
                    <div className="bg-white rounded-lg p-4 border border-gray-100">
                      <h3 className="font-bold text-gray-900 mb-2 flex items-center gap-2">
                        <Upload size={18} />
                        ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
                      </h3>
                      <p className="text-xs text-gray-500 mb-3">
                        ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒã—ã¾ã™ã€‚
                        <span className="text-rose-500 font-bold">â€»ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™</span>
                      </p>
                      <input 
                        type="file" 
                        accept=".json" 
                        ref={fileInputRef} 
                        onChange={handleFileChange} 
                        className="hidden" 
                      />
                      <button onClick={handleImportClick} className="w-full border border-slate-300 text-slate-700 py-2 rounded-lg text-sm font-bold flex justify-center items-center gap-2 hover:bg-slate-50">
                        <Upload size={16} />
                        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                      </button>
                    </div>

                    {/* ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– */}
                    <div className="bg-rose-50 rounded-lg p-4 border border-rose-100 mt-8">
                      <h3 className="font-bold text-rose-700 mb-2 text-sm">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</h3>
                      <button onClick={handleResetAll} className="w-full bg-white border border-rose-300 text-rose-600 py-2 rounded-lg text-xs hover:bg-rose-50">
                        ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                      </button>
                    </div>

                    <div className="text-center text-xs text-gray-400 mt-4">
                      App Version 1.3.0 Final
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Bottom Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-10">
            <div className="max-w-lg mx-auto flex">
              {[
                { id: 'list', label: 'ä¸€è¦§', icon: 'ğŸ“‹' },
                { id: 'matrix', label: 'åˆ†æ', icon: 'ğŸ“Š' },
                { id: 'analysis', label: 'ã‚°ãƒ©ãƒ•', icon: 'ğŸ“ˆ' },
                { id: 'history', label: 'å±¥æ­´', icon: 'ğŸ“œ' },
                { id: 'settings', label: 'è¨­å®š', icon: <Settings size={20} /> }
              ].map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-3 text-center ${activeTab === tab.id ? 'text-slate-700 font-medium' : 'text-gray-400'}`}>
                  <div className="text-lg flex justify-center h-6 items-center">{tab.icon}</div>
                  <div className="text-[10px] mt-0.5">{tab.label}</div>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Service Worker ç™»éŒ²
    if ('serviceWorker' in navigator) {
      if (['http:', 'https:'].includes(window.location.protocol)) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => console.log('SW registered'))
          .catch(error => console.log('SW registration failed:', error));
      }
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
